<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Gestión de Datos</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>
<body>

<div class="container-fluid">
    <div class="row">        
        <!-- SIDEBAR (Igual que index, pero marcando Gestión como activo si quisieras estilo extra) -->
        <div class="col-md-3 col-lg-2 sidebar-container d-flex flex-column">
            <div class="logo-area text-center mb-4 mt-2">
                <img src="static/img/logo.png" alt="Logo" class="img-fluid mb-2" style="max-height: 60px;">
                <h4 style="color: var(--primary-color); font-weight:800;">GESTIÓN</h4>
            </div>

            <div class="control-group">
                <a href="index.html" class="btn btn-outline-primary w-100 fw-bold mb-3">
                    &larr; Volver al Dashboard
                </a>
                
                <hr class="my-4 opacity-25">
                
                <div class="alert alert-info small">
                    <strong>Modo Gestión:</strong><br>
                    Aquí puedes subir nuevos archivos CSV/Excel o eliminar cargas erróneas anteriores.
                </div>
            </div>
        </div>

        <!-- MAIN CONTENT -->
        <div class="col-md-9 col-lg-10 main-container">
            <h1>Gestión de Datos</h1>

            <!-- TARJETA 1: SUBIR NUEVOS DATOS -->
            <div class="row mb-5">
                <div class="col-md-8 mx-auto">
                    <div class="vis-container">
                        <h3>Importar Nuevos Datos</h3>
                        <form id="gestionUploadForm">
                            <div class="mb-3">
                                <label class="form-label fw-bold">Seleccionar Sensor</label>
                                <select id="gestionSensorSelect" class="form-select" required>
                                    <option value="">Cargando sensores...</option>
                                </select>
                                <div class="form-text small text-muted">
                                    Selecciona el sensor base para ver sus versiones disponibles.
                                </div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label fw-bold">Seleccionar Versión</label>
                                <select id="gestionVersionSelect" class="form-select" required>
                                    <option value="">-- Selecciona versión --</option>
                                </select>
                                <div class="form-text small text-muted">
                                    Los datos se guardarán en la versión elegida.
                                </div>
                            </div>
                            <div class="mb-4">
                                <label class="form-label fw-bold">Archivo CSV / Excel</label>
                                <input type="file" name="file" class="form-control" accept=".csv" required>
                            </div>
                            <button type="submit" class="btn btn-success w-100 fw-bold py-2">
                                SUBIR DATOS AHORA
                            </button>
                        </form>
                    </div>
                </div>
            </div>

            <!-- TARJETA: ELIMINAR LECTURAS PROFUNDIDAD 0 -->
            <div class="row mb-4">
                <div class="col-md-8 mx-auto">
                    <div class="vis-container border-warning">
                        <h3>Limpieza de datos</h3>
                        <p class="text-muted small mb-3">
                            Elimina de todos los inclinómetros los registros cuya profundidad sea 0. Esta acción no se puede deshacer.
                        </p>
                        <button type="button" id="btnDeleteProfCero" class="btn btn-warning fw-bold">
                            Eliminar lecturas con profundidad 0
                        </button>
                    </div>
                </div>
            </div>

            <!-- TARJETA 2: HISTORIAL Y BORRADO -->
            <div class="row">
                <div class="col-12">
                    <div class="vis-container">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h3>Historial de Cargas (Últimas 50)</h3>
                            <button onclick="loadHistory()" class="btn btn-sm btn-outline-secondary">Refrescar</button>
                        </div>
                        
                        <div class="table-responsive">
                            <table class="table table-hover align-middle">
                                <thead class="table-light">
                                    <tr>
                                        <th>Fecha Subida</th>
                                        <th>Sensor</th>
                                        <th>Archivo Original</th>
                                        <th>Usuario</th>
                                        <th>Registros</th>
                                        <th class="text-end">Acciones</th>
                                    </tr>
                                </thead>
                                <tbody id="historyTableBody">
                                    <tr><td colspan="6" class="text-center">Cargando historial...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>
</div>

<script>
    // Lógica Específica de Gestión
        document.addEventListener('DOMContentLoaded', () => {
        checkAuth();
        loadSensorsForGestion();
        loadHistory();

        // Botón eliminar lecturas profundidad 0
        document.getElementById('btnDeleteProfCero').addEventListener('click', deleteLecturasProfundidadCero);

        // Listener del Formulario
        document.getElementById('gestionUploadForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const sensorId = document.getElementById('gestionVersionSelect').value;
            if(!sensorId) return Swal.fire('Error', 'Selecciona una versión', 'warning');

            const formData = new FormData(e.target);
            formData.append('sensor_id', sensorId);

            try {
                Swal.fire({title: 'Subiendo...', didOpen: () => Swal.showLoading()});
                const res = await axios.post('api.php?action=upload', formData, { 
                    headers: {'Content-Type': 'multipart/form-data'} 
                });
                
                if(res.data.success) {
                    Swal.fire('Éxito', res.data.message, 'success');
                    e.target.reset();
                    loadHistory(); // Recargar tabla
                } else {
                    Swal.fire('Error', res.data.message, 'error');
                }
            } catch(err) {
                console.error(err);
                Swal.fire('Error', 'Fallo de conexión', 'error');
            }
        });
    });

    async function checkAuth() {
        const res = await axios.get('api.php?action=check_session');
        if (!res.data.logged_in) window.location.href = 'login.html';
        if (res.data.rol === 'cliente') {
            alert('Acceso denegado');
            window.location.href = 'index.html';
        }
    }

    async function loadSensorsForGestion() {
        try {
            const res = await axios.get('api.php?action=get_sensors');
            const sel = document.getElementById('gestionSensorSelect');
            sel.innerHTML = '<option value="">-- Selecciona Sensor --</option>';
            res.data.forEach(s => {
                const opt = document.createElement('option');
                opt.value = s.id;
                opt.textContent = s.nombre;
                sel.appendChild(opt);
            });
            // Cargar versiones cuando el usuario elija sensor
            sel.addEventListener('change', () => {
                const baseId = sel.value;
                loadVersionsForGestion(baseId);
            });
        } catch(err) { console.error(err); }
    }

    async function loadVersionsForGestion(baseId) {
        const versionSel = document.getElementById('gestionVersionSelect');
        if (!versionSel) return;
        versionSel.innerHTML = '<option value="">Cargando versiones...</option>';

        if (!baseId) {
            versionSel.innerHTML = '<option value="">-- Selecciona versión --</option>';
            return;
        }

        try {
            const res = await axios.get(`api.php?action=get_versions&id=${baseId}`);
            const versiones = res.data || [];

            if (versiones.length === 0) {
                versionSel.innerHTML = '<option value="">Sin versiones disponibles</option>';
                return;
            }

            versionSel.innerHTML = '<option value="">-- Selecciona versión --</option>';
            const versionConFinMasReciente = versiones.reduce((acc, v) => {
                if (!v.f_fin) return acc;
                const ts = new Date(v.f_fin.split('/').reverse().join('-')).getTime();
                if (!acc || ts > acc.ts) return { id: v.id, ts };
                return acc;
            }, null);

            versiones.forEach(v => {
                const opt = document.createElement('option');
                opt.value = v.id;
                let texto = 'Período: Sin datos';
                if (v.f_ini && v.f_fin) {
                    texto = `Período: ${v.f_ini} - ${v.f_fin}`;
                }
                if (versionConFinMasReciente && v.id == versionConFinMasReciente.id) {
                    texto += ' (Actual)';
                }
                opt.textContent = texto;
                versionSel.appendChild(opt);
            });

            // Seleccionamos por defecto la versión más alta (primera)
            if (versiones[0] && versiones[0].id) {
                versionSel.value = versiones[0].id;
            }
        } catch (err) {
            console.error(err);
            versionSel.innerHTML = '<option value="">Error cargando versiones</option>';
        }
    }

    async function loadHistory() {
        const tbody = document.getElementById('historyTableBody');
        try {
            const res = await axios.get('api.php?action=get_uploads');
            tbody.innerHTML = '';
            
            if(res.data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">No hay historial disponible</td></tr>';
                return;
            }

            res.data.forEach(item => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td><small class="fw-bold">${item.fecha_fmt}</small></td>
                    <td><span class="badge bg-info text-dark">${item.sensor_nombre}</span></td>
                    <td>${item.nombre_archivo}</td>
                    <td><small class="text-muted">${item.usuario}</small></td>
                    <td>${item.num_datos}</td>
                    <td class="text-end">
                        <button onclick="deleteUpload(${item.id})" class="btn btn-sm btn-outline-danger">
                            Borrar
                        </button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        } catch(err) { 
            tbody.innerHTML = '<tr><td colspan="6" class="text-center text-danger">Error cargando historial</td></tr>';
        }
    }

    async function deleteLecturasProfundidadCero() {
        const result = await Swal.fire({
            title: '¿Eliminar lecturas con profundidad 0?',
            text: 'Se borrarán de todos los inclinómetros los registros donde profundidad = 0. No se puede deshacer.',
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#f0ad4e',
            confirmButtonText: 'Sí, eliminar'
        });

        if (result.isConfirmed) {
            try {
                const res = await axios.post('api.php?action=delete_lecturas_profundidad_cero');
                if (res.data.success) {
                    Swal.fire('Hecho', res.data.message, 'success');
                } else {
                    Swal.fire('Error', res.data.message, 'error');
                }
            } catch (err) {
                Swal.fire('Error', 'Fallo de conexión', 'error');
            }
        }
    }

    window.deleteUpload = async function(id) {
        const result = await Swal.fire({
            title: '¿Estás seguro?',
            text: "Se borrarán todos los datos asociados a esta subida. No se puede deshacer.",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#d33',
            confirmButtonText: 'Sí, borrar todo'
        });

        if (result.isConfirmed) {
            try {
                const formData = new FormData();
                formData.append('id', id);
                const res = await axios.post('api.php?action=delete_upload', formData);
                
                if(res.data.success) {
                    Swal.fire('Borrado', 'Los datos han sido eliminados.', 'success');
                    loadHistory();
                } else {
                    Swal.fire('Error', res.data.message, 'error');
                }
            } catch(err) {
                Swal.fire('Error', 'Fallo de conexión', 'error');
            }
        }
    }
</script>
</body>
</html>